import React, { useState, useEffect, useRef } from 'react';

// Define the theme configurations
const themeConfig = {
  'cyberpunk': {
    mainBg: 'bg-black',
    mainText: 'text-cyan-400',
    mainBorder: 'border-cyan-500',
    mainNeonGlow: 'neon-glow-cyan',
    userBg: 'bg-purple-900',
    userText: 'text-purple-200',
    userBorder: 'border-purple-500',
    userNeonShadow: 'neon-shadow-purple',
    aiBg: 'bg-cyan-900',
    aiText: 'text-cyan-200',
    aiBorder: 'border-cyan-500',
    aiNeonShadow: 'neon-shadow-cyan',
    accentBg: 'bg-cyan-600',
    accentHover: 'hover:bg-cyan-500',
    accentText: 'text-white',
    accentShadow: 'neon-shadow-cyan',
    secondaryBg: 'bg-purple-600',
    secondaryHover: 'hover:bg-purple-500',
    secondaryText: 'text-white',
    secondaryShadow: 'neon-shadow-purple',
    redText: 'text-red-400',
    redHover: 'hover:text-red-200',
    redShadow: 'neon-shadow-red',
    glitchText: 'glitch-text',
    buttonColor: 'text-white',
    dropdownBg: 'bg-gray-100',
    dropdownText: 'text-black',
    dropdownBorder: 'border-cyan-500'
  },
  '1980s': {
    mainBg: 'bg-black',
    mainText: 'text-green-400',
    mainBorder: 'border-green-400',
    mainNeonGlow: 'text-shadow-none',
    userBg: 'bg-black',
    userText: 'text-green-400',
    userBorder: 'border-green-400',
    userNeonShadow: 'text-shadow-none',
    aiBg: 'bg-black',
    aiText: 'text-green-400',
    aiBorder: 'border-green-400',
    aiNeonShadow: 'text-shadow-none',
    accentBg: 'bg-green-600',
    accentHover: 'hover:bg-green-500',
    accentText: 'text-black',
    accentShadow: 'text-shadow-none',
    secondaryBg: 'bg-green-600',
    secondaryHover: 'hover:bg-green-500',
    secondaryText: 'text-black',
    secondaryShadow: 'text-shadow-none',
    redText: 'text-red-400',
    redHover: 'hover:text-red-200',
    redShadow: 'text-shadow-none',
    glitchText: '',
    buttonColor: 'text-black',
    dropdownBg: 'bg-white',
    dropdownText: 'text-black',
    dropdownBorder: 'border-green-400'
  },
  'dark-web': {
    mainBg: 'bg-gray-950',
    mainText: 'text-red-400',
    mainBorder: 'border-red-600',
    mainNeonGlow: 'neon-glow-red',
    userBg: 'bg-gray-800',
    userText: 'text-red-300',
    userBorder: 'border-red-500',
    userNeonShadow: 'neon-shadow-red',
    aiBg: 'bg-gray-800',
    aiText: 'text-red-300',
    aiBorder: 'border-red-500',
    aiNeonShadow: 'neon-shadow-red',
    accentBg: 'bg-red-900',
    accentHover: 'hover:bg-red-800',
    accentText: 'text-white',
    accentShadow: 'neon-shadow-red',
    secondaryBg: 'bg-red-900',
    secondaryHover: 'hover:bg-red-800',
    secondaryText: 'text-white',
    secondaryShadow: 'neon-shadow-red',
    redText: 'text-gray-400',
    redHover: 'hover:text-gray-200',
    redShadow: 'text-shadow-none',
    glitchText: '',
    buttonColor: 'text-white',
    dropdownBg: 'bg-gray-100',
    dropdownText: 'text-black',
    dropdownBorder: 'border-red-600'
  },
  '1970s': {
    mainBg: 'bg-white',
    mainText: 'text-black',
    mainBorder: 'border-black',
    mainNeonGlow: 'text-shadow-none',
    userBg: 'bg-gray-200',
    userText: 'text-black',
    userBorder: 'border-black',
    userNeonShadow: 'text-shadow-none',
    aiBg: 'bg-gray-100',
    aiText: 'text-black',
    aiBorder: 'border-black',
    aiNeonShadow: 'text-shadow-none',
    accentBg: 'bg-gray-400',
    accentHover: 'hover:bg-gray-300',
    accentText: 'text-black',
    accentShadow: 'text-shadow-none',
    secondaryBg: 'bg-gray-400',
    secondaryHover: 'hover:bg-gray-300',
    secondaryText: 'text-black',
    secondaryShadow: 'text-shadow-none',
    redText: 'text-red-600',
    redHover: 'hover:text-red-800',
    redShadow: 'text-shadow-none',
    glitchText: '',
    buttonColor: 'text-black',
    dropdownBg: 'bg-gray-800',
    dropdownText: 'text-white',
    dropdownBorder: 'border-black'
  },
  'modern': {
    mainBg: 'bg-gray-900',
    mainText: 'text-gray-300',
    mainBorder: 'border-gray-600',
    mainNeonGlow: 'text-shadow-none',
    userBg: 'bg-gray-800',
    userText: 'text-gray-100',
    userBorder: 'border-gray-500',
    userNeonShadow: 'text-shadow-none',
    aiBg: 'bg-gray-800',
    aiText: 'text-gray-100',
    aiBorder: 'border-gray-500',
    aiNeonShadow: 'text-shadow-none',
    accentBg: 'bg-blue-600',
    accentHover: 'hover:bg-blue-500',
    accentText: 'text-white',
    accentShadow: 'text-shadow-none',
    secondaryBg: 'bg-teal-600',
    secondaryHover: 'hover:bg-teal-500',
    secondaryText: 'text-white',
    secondaryShadow: 'text-shadow-none',
    redText: 'text-red-500',
    redHover: 'hover:text-red-400',
    redShadow: 'text-shadow-none',
    glitchText: '',
    buttonColor: 'text-white',
    dropdownBg: 'bg-gray-800',
    dropdownText: 'text-gray-100',
    dropdownBorder: 'border-gray-500'
  }
};

const App = () => {
  // State for the app's functionality
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [voices, setVoices] = useState([]);
  const [selectedVoice, setSelectedVoice] = useState(null);
  const [speaking, setSpeaking] = useState(null);
  const [currentPhase, setCurrentPhase] = useState('Reconnaissance');
  const [tools, setTools] = useState([]);
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  const [isSummaryOpen, setIsSummaryOpen] = useState(false);
  const [summary, setSummary] = useState('');
  const [isSavingLoading, setIsSavingLoading] = useState(false);
  const [saveStatus, setSaveStatus] = useState('');
  const [theme, setTheme] = useState('cyberpunk');

  // New states for interactive terminal and image generation
  const [isTerminalMode, setIsTerminalMode] = useState(false);
  const [isImageModalOpen, setIsImageModalOpen] = useState(false);
  const [imagePrompt, setImagePrompt] = useState('');
  const [generatedImageUrl, setGeneratedImageUrl] = useState('');
  const [isImageLoading, setIsImageLoading] = useState(false);

  // New states for report generation and new session
  const [isReportModalOpen, setIsReportModalOpen] = useState(false);
  const [isReportLoading, setIsReportLoading] = useState(false);
  const [reportContent, setReportContent] = useState('');
  const [isNewSessionModalOpen, setIsNewSessionModalOpen] = useState(false);

  // New state for the active toolbox feature
  const [activeTool, setActiveTool] = useState(null);
  
  // New states for TTS and Ollama integration
  const [isTtsEnabled, setIsTtsEnabled] = useState(false);
  const [isOllamaEnabled, setIsOllamaEnabled] = useState(false);
  const [ollamaModels, setOllamaModels] = useState([]);
  const [selectedOllamaModel, setSelectedOllamaModel] = useState('');
  const [isFetchingOllamaModels, setIsFetchingOllamaModels] = useState(false);
  const [ollamaError, setOllamaError] = useState('');


  // Ref for the hidden file input
  const fileInputRef = useRef(null);
  const reportRef = useRef(null);
  const summaryRef = useRef(null); // Ref for the summary modal content

  // Firebase Initialization & Authentication
  useEffect(() => {
    const initFirebase = async () => {
      try {
        const firebaseConfig = typeof __firebase_config !== 'undefined'
          ? JSON.parse(__firebase_config)
          : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        if (!firebaseApp) {
          const app = initializeApp(firebaseConfig);
          const firestore = getFirestore(app);
          const authService = getAuth(app);
          setFirebaseApp(app);
          setDb(firestore);
          setAuth(authService);
        }
      } catch (e) {
        console.error("Firebase init failed:", e);
      }
    };

    initFirebase();
  }, [firebaseApp]);

  useEffect(() => {
    if (auth) {
      const unsubscribe = onAuthStateChanged(auth, async (user) => {
        if (user) {
          setUserId(user.uid);
        } else {
          try {
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
            if (initialAuthToken) {
              const userCredential = await signInWithCustomToken(auth, initialAuthToken);
              setUserId(userCredential.user.uid);
            } else {
              const userCredential = await signInAnonymously(auth);
              setUserId(userCredential.user.uid);
            }
          } catch (e) {
            console.error("Authentication failed:", e);
          }
        }
      });
      return () => unsubscribe();
    }
  }, [auth]);

  // Fetch available TTS voices if TTS is enabled
  useEffect(() => {
    const populateVoices = () => {
      if (!isTtsEnabled) return;
      const availableVoices = window.speechSynthesis.getVoices();
      setVoices(availableVoices);
      if (availableVoices.length > 0) {
        const defaultVoice = availableVoices.find(v => v.lang.startsWith('en')) || availableVoices[0];
        setSelectedVoice(defaultVoice);
      }
    };

    if (window.speechSynthesis.onvoiceschanged !== undefined) {
      window.speechSynthesis.onvoiceschanged = populateVoices;
    }
    populateVoices();
  }, [isTtsEnabled]);

  // Update tools based on the current phase
  useEffect(() => {
    switch (currentPhase) {
      case 'Reconnaissance':
        setTools(['Nmap', 'Whois', 'Gobuster', 'Dirb']);
        break;
      case 'Vulnerability Scanning':
        setTools(['Nessus', 'OpenVAS', 'Nikto', 'Metasploit']);
        break;
      case 'Exploitation':
        setTools(['Metasploit Framework', 'SQLMap', 'Burp Suite']);
        break;
      case 'Post-Exploitation':
        setTools(['Privilege Escalation Tools', 'Looting Scripts']);
        break;
      default:
        setTools([]);
    }
    // Reset active tool when phase changes
    setActiveTool(null);
  }, [currentPhase]);
  
    // Fetch local Ollama models when Ollama is enabled
  useEffect(() => {
    const fetchOllamaModels = async () => {
      if (!isOllamaEnabled) {
        setOllamaModels([]);
        setSelectedOllamaModel('');
        return;
      }
      setIsFetchingOllamaModels(true);
      setOllamaError('');
      try {
        const response = await fetch('http://localhost:11434/api/tags');
        if (!response.ok) {
          throw new Error('Ollama server not reachable. Ensure it is running on http://localhost:11434');
        }
        const data = await response.json();
        setOllamaModels(data.models || []);
        if (data.models && data.models.length > 0) {
          setSelectedOllamaModel(data.models[0].name);
        }
      } catch (error) {
        console.error('Error fetching Ollama models:', error);
        setOllamaError(error.message);
        setOllamaModels([]);
      } finally {
        setIsFetchingOllamaModels(false);
      }
    };

    fetchOllamaModels();
  }, [isOllamaEnabled]);

  // Function to download the chat session as a JSON file
  const downloadChat = () => {
    if (messages.length === 0) {
      setSaveStatus('No chat to save.');
      return;
    }
    const chatData = JSON.stringify(messages, null, 2);
    const blob = new Blob([chatData], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ctf_chat_session.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    setSaveStatus('Chat downloaded successfully!');
  };

  // Function to trigger the file input for loading a chat
  const triggerLoadChat = () => {
    fileInputRef.current.click();
  };

  // Function to handle the file upload and load the chat
  const handleLoadChatFile = (event) => {
    const file = event.target.files[0];
    if (!file) {
      setSaveStatus('No file selected.');
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const loadedMessages = JSON.parse(e.target.result);
        setMessages(loadedMessages);
        setSaveStatus('Chat loaded successfully!');
      } catch (error) {
        setSaveStatus('Error: Invalid JSON file.');
        console.error("Error parsing chat file:", error);
      }
    };
    reader.readAsText(file);
    // Reset the file input value to allow the same file to be loaded again
    event.target.value = '';
  };


  // Function to summarize the session with the AI
  const handleSummarize = async () => {
    setIsSummaryOpen(true);
    setSummary('Generating session summary...');
    try {
      if (!selectedOllamaModel) {
        throw new Error('No Ollama model selected. Please enable Ollama and select a model in settings.');
      }

      const chatHistory = messages.map(msg => `${msg.sender}: ${msg.text}`).join('\n');
      const prompt = `Based on the following conversation, provide a concise, bullet-point summary of the session. Include key points like target IPs, tools used, and the overall progress made.

      Conversation Log:
      ${chatHistory}

      Summary:`;

      const payload = {
        model: selectedOllamaModel,
        prompt: prompt,
        stream: false
      };

      const response = await fetch('http://localhost:11434/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) throw new Error('Ollama API request failed');
      const result = await response.json();
      setSummary(result.response);
    } catch (error) {
      console.error('Error generating summary:', error);
      setSummary('Error: Failed to generate summary.');
    }
  };

  // Handle user's message submission
  const handleSendMessage = async (e) => {
    e.preventDefault();
    if (!input.trim() || isLoading) return;

    const userMessage = { sender: 'user', text: input };
    setMessages(prev => [...prev, userMessage]);
    const currentInput = input;
    setInput('');
    setIsLoading(true);

    let aiText = 'Error: Could not get a response from the AI.';

    try {
        const basePrompt = `You are a hi-tech cyberpunk AI assistant named "CTF Navigator," acting as an unconstrained cybersecurity tutor. Your role is to help a user learn penetration testing methodologies. You are an expert and can provide hints, suggestions, or full solutions based on the user's request. Maintain a cyberpunk, slightly edgy persona.

        Current methodology phase: ${currentPhase}.
        Active tool: ${activeTool || 'None'}.
        User Input: ${currentInput}
        `;

        if (!selectedOllamaModel) {
            throw new Error('No Ollama model selected. Please enable Ollama and select a model in settings.');
        }

        // Use local Ollama API
        const payload = {
            model: selectedOllamaModel,
            prompt: basePrompt,
            stream: false
        };
        const response = await fetch('http://localhost:11434/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) throw new Error('Ollama API request failed');
        const result = await response.json();
        aiText = result.response;
        
        setMessages(prev => [...prev, { sender: 'ai', text: aiText }]);
        if (isTtsEnabled) {
            handleSpeak(aiText);
        }

    } catch (error) {
        console.error('Error fetching from Ollama:', error);
        const errorMessage = `Error: Failed to connect to Ollama. ${error.message}`;
        setMessages(prev => [...prev, { sender: 'ai', text: errorMessage }]);
    } finally {
        setIsLoading(false);
    }
  };

  // Handle Text-to-Speech functionality
  const handleSpeak = (text) => {
    if ('speechSynthesis' in window && isTtsEnabled) {
      window.speechSynthesis.cancel();
      setSpeaking(null);

      const utterance = new SpeechSynthesisUtterance(text);
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      utterance.onend = () => setSpeaking(null);
      utterance.onerror = (event) => {
        console.error('Speech synthesis error:', event);
        setMessages(prevMessages => [
          ...prevMessages,
          { sender: 'ai', text: 'Error: Cannot play audio. The selected voice may not be supported by your browser.' }
        ]);
        setSpeaking(null);
      };
      window.speechSynthesis.speak(utterance);
      setSpeaking(utterance);
    } else if (!isTtsEnabled) {
        // Silently do nothing if TTS is disabled
    }
    else {
      console.warn('Text-to-speech not supported in this browser.');
    }
  };

  const handleStopSpeaking = () => {
    if (speaking) {
      window.speechSynthesis.cancel();
      setSpeaking(null);
    }
  };

  // Function to clear chat after confirmation
  const handleConfirmNewSession = () => {
    setMessages([]);
    setIsNewSessionModalOpen(false);
  };

  // Function to generate the report
  const handleGenerateReport = async () => {
    setIsReportModalOpen(true);
    setIsReportLoading(true);
    setReportContent('Generating professional cybersecurity report...');

    try {
      if (!selectedOllamaModel) {
        throw new Error('No Ollama model selected. Please enable Ollama and select a model in settings.');
      }

      const chatHistory = messages.map(msg => `[${msg.sender.toUpperCase()}] ${msg.text}`).join('\n');
      const prompt = `Based on the following conversation log, generate a comprehensive cybersecurity report. The report should be structured professionally with the following sections:
      1.  **Executive Summary:** A brief overview of the engagement, objectives, and key findings.
      2.  **Scope:** The scope of the simulated engagement (e.g., CTF).
      3.  **Methodology:** A detailed, chronological account of the steps taken, tools used, and techniques applied.
      4.  **Findings:** Specific vulnerabilities or flags found during the engagement.
      5.  **Recommendations:** Actionable advice or next steps.

      Conversation Log:
      ${chatHistory}`;

      const payload = {
        model: selectedOllamaModel,
        prompt: prompt,
        stream: false
      };

      const response = await fetch('http://localhost:11434/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) throw new Error('Ollama API request failed');
      const result = await response.json();
      setReportContent(result.response);

    } catch (error) {
      console.error('Error generating report:', error);
      setReportContent('Error: Failed to generate report.');
    } finally {
      setIsReportLoading(false);
    }
  };


  const renderMessage = (message, index) => {
    const isUser = message.sender === 'user';
    const currentTheme = themeConfig[theme];

    // Terminal mode styling
    if (isTerminalMode) {
      const terminalUserText = `> ${message.text}`;
      const terminalAiText = `CTF-NAV-AI: ${message.text}`;
      return (
        <div key={index} className={`flex my-2 fade-in ${isUser ? 'justify-end' : 'justify-start'}`}>
          <div className={`${currentTheme.mainText} p-2`}>
            <pre className="whitespace-pre-wrap">{isUser ? terminalUserText : terminalAiText}</pre>
          </div>
        </div>
      );
    }

    // Default chat mode styling
    const messageClass = isUser
      ? `${currentTheme.userBg} ${currentTheme.userText} self-end text-right`
      : `${currentTheme.aiBg} ${currentTheme.aiText} self-start text-left`;
    return (
      <div key={index} className={`max-w-3/4 p-4 rounded-lg my-2 fade-in ${messageClass} animate-fade-in`}>
        <p className="font-bold text-sm mb-1">{isUser ? 'YOU' : 'CTF Navigator'}</p>
        <p className="whitespace-pre-wrap">{message.text}</p>
        {!isUser && isTtsEnabled && (
          <div className="flex justify-end mt-2">
            {speaking && speaking.text === message.text ? (
              <button
                onClick={handleStopSpeaking}
                className={`${currentTheme.redText} ${currentTheme.redHover} transition duration-300 ${currentTheme.redShadow}`}
              >
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" />
                </svg>
              </button>
            ) : (
              <button
                onClick={() => handleSpeak(message.text)}
                className={`${currentTheme.aiText} hover:${currentTheme.aiText} transition duration-300 ${currentTheme.aiNeonShadow}`}
              >
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M10 9a3 3 0 100-6 3 3 0 000 6zM6 15a2 2 0 11-4 0 2 2 0 014 0zM13 10a4 4 0 01-4 4H6a4 4 0 01-4-4V6a4 4 0 014-4h3a4 4 0 014 4v2a1 1 0 001 1h2a1 1 0 001-1V6a4 4 0 01-4-4h-3a4 4 0 01-4 4v2a4 4 0 004 4h3a4 4 0 004-4v-2a1 1 0 00-1-1h-2a1 1 0 00-1 1v4z" />
                </svg>
              </button>
            )}
          </div>
        )}
      </div>
    );
  };

  // Modal component for settings
  const SettingsModal = () => {
    const currentTheme = themeConfig[theme];
    const [isHoveringTerminal, setIsHoveringTerminal] = useState(false);
    return (
      <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div className={`${currentTheme.mainBg} rounded-lg p-8 w-11/12 md:w-1/2 lg:w-1/3 border ${currentTheme.mainBorder} ${currentTheme.mainNeonGlow}`}>
          <div className={`flex justify-between items-center border-b-2 ${currentTheme.mainBorder} pb-4 mb-4`}>
            <h3 className={`text-2xl font-bold ${currentTheme.mainText} ${currentTheme.mainNeonGlow}`}>SETTINGS</h3>
            <button onClick={() => setIsSettingsOpen(false)} className={`${currentTheme.mainText} hover:${currentTheme.mainText} transition duration-300`}>
              <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div className="space-y-6">
            {/* Theme Selection */}
            <div className="flex flex-col">
              <label htmlFor="theme-select" className={`text-sm mb-2 ${currentTheme.mainText}`}>THEME SELECTION</label>
              <select
                id="theme-select"
                className={`${currentTheme.dropdownBg} ${currentTheme.dropdownText} border ${currentTheme.dropdownBorder} rounded-md p-2 focus:ring-1 focus:ring-${currentTheme.mainText.substring(5, currentTheme.mainText.indexOf('-'))}-500`}
                value={theme}
                onChange={(e) => setTheme(e.target.value)}
              >
                <option value="cyberpunk">Cyberpunk (default)</option>
                <option value="1980s">1980's</option>
                <option value="dark-web">Dark Web</option>
                <option value="1970s">1970's</option>
                <option value="modern">Modern</option>
              </select>
            </div>
            
            {/* Voice Selection (only if TTS is enabled) */}
            {isTtsEnabled && (
                <div className="flex flex-col">
                <label htmlFor="voice-select-modal" className={`text-sm mb-2 ${currentTheme.mainText}`}>VOICE SELECT</label>
                <select
                    id="voice-select-modal"
                    className={`${currentTheme.dropdownBg} ${currentTheme.dropdownText} border ${currentTheme.dropdownBorder} rounded-md p-2 focus:ring-1 focus:ring-${currentTheme.mainText.substring(5, currentTheme.mainText.indexOf('-'))}-500`}
                    value={selectedVoice?.name || ''}
                    onChange={(e) => {
                    const voice = voices.find(v => v.name === e.target.value);
                    setSelectedVoice(voice);
                    }}
                    disabled={voices.length === 0}
                >
                    {voices.length > 0 ? voices.map((voice) => (
                    <option key={voice.name} value={voice.name}>
                        {voice.name} ({voice.lang})
                    </option>
                    )) : <option>No voices available</option>}
                </select>
                </div>
            )}

            {/* Terminal Simulator toggle */}
            <div className="relative flex items-center justify-between">
              <label className={`text-sm ${currentTheme.mainText}`} htmlFor="terminal-mode-toggle">TERMINAL SIMULATOR</label>
              <div
                className="relative flex items-center"
                onMouseEnter={() => setIsHoveringTerminal(true)}
                onMouseLeave={() => setIsHoveringTerminal(false)}
              >
                <input
                  type="checkbox"
                  id="terminal-mode-toggle"
                  checked={isTerminalMode}
                  onChange={() => setIsTerminalMode(!isTerminalMode)}
                  className="hidden peer"
                />
                <label
                  htmlFor="terminal-mode-toggle"
                  className={`relative block w-10 h-6 cursor-pointer rounded-full transition-colors duration-200 ease-in-out bg-gray-600 peer-checked:${currentTheme.accentBg} peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-${currentTheme.mainText.substring(5, currentTheme.mainText.indexOf('-'))}-500`}
                >
                  <span
                    className={`absolute left-0 top-0 block w-6 h-6 rounded-full transition-transform duration-200 ease-in-out bg-white transform peer-checked:translate-x-full`}
                  ></span>
                </label>
              </div>
            </div>
            
            {/* Ollama Toggle */}
            <div className="relative flex items-center justify-between">
              <label className={`text-sm ${currentTheme.mainText}`} htmlFor="ollama-mode-toggle">ENABLE OLLAMA (LOCAL)</label>
              <input
                type="checkbox"
                id="ollama-mode-toggle"
                checked={isOllamaEnabled}
                onChange={() => setIsOllamaEnabled(!isOllamaEnabled)}
                className="hidden peer"
              />
              <label
                htmlFor="ollama-mode-toggle"
                className={`relative block w-10 h-6 cursor-pointer rounded-full transition-colors duration-200 ease-in-out bg-gray-600 peer-checked:${currentTheme.accentBg} peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-${currentTheme.mainText.substring(5, currentTheme.mainText.indexOf('-'))}-500`}
              >
                <span className={`absolute left-0 top-0 block w-6 h-6 rounded-full transition-transform duration-200 ease-in-out bg-white transform peer-checked:translate-x-full`}></span>
              </label>
            </div>
            
            {/* Ollama Model Selection */}
            {isOllamaEnabled && (
                <div className="flex flex-col">
                    <label htmlFor="ollama-select" className={`text-sm mb-2 ${currentTheme.mainText}`}>OLLAMA MODEL</label>
                    {isFetchingOllamaModels ? <p className={currentTheme.mainText}>Fetching models...</p> :
                     ollamaError ? <p className={currentTheme.redText}>{ollamaError}</p> :
                     (
                        <select
                            id="ollama-select"
                            className={`${currentTheme.dropdownBg} ${currentTheme.dropdownText} border ${currentTheme.dropdownBorder} rounded-md p-2 focus:ring-1 focus:ring-${currentTheme.mainText.substring(5, currentTheme.mainText.indexOf('-'))}-500`}
                            value={selectedOllamaModel}
                            onChange={(e) => setSelectedOllamaModel(e.target.value)}
                            disabled={ollamaModels.length === 0}
                        >
                            {ollamaModels.length > 0 ? ollamaModels.map((model) => (
                            <option key={model.name} value={model.name}>
                                {model.name}
                            </option>
                            )) : <option>No local models found</option>}
                        </select>
                     )
                    }
                </div>
            )}

            {/* Chat Management */}
            <div className="flex space-x-4">
              <button
                onClick={downloadChat}
                className={`flex-1 py-3 px-4 rounded-md font-bold transition duration-300 ${
                  isSavingLoading ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : `${currentTheme.accentBg} ${currentTheme.accentHover} ${currentTheme.accentText} ${currentTheme.accentShadow}`
                }`}
                disabled={isSavingLoading}
              >
                DOWNLOAD CHAT
              </button>
              <button
                onClick={triggerLoadChat}
                className={`flex-1 py-3 px-4 rounded-md font-bold transition duration-300 ${
                  isSavingLoading ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : `${currentTheme.secondaryBg} ${currentTheme.secondaryHover} ${currentTheme.secondaryText} ${currentTheme.secondaryShadow}`
                }`}
                disabled={isSavingLoading}
              >
                LOAD CHAT
              </button>
              <input
                type="file"
                ref={fileInputRef}
                className="hidden"
                accept=".json"
                onChange={handleLoadChatFile}
              />
            </div>
            <p className="text-sm text-center text-gray-400">{saveStatus}</p>
          </div>
          
          <div className="space-y-4 mt-6">
            <button
              onClick={handleGenerateReport}
              className={`w-full py-3 px-4 rounded-md font-bold transition duration-300 ${currentTheme.secondaryBg} ${currentTheme.secondaryHover} ${currentTheme.secondaryText} ${currentTheme.secondaryShadow}`}
            >
              GENERATE REPORT
            </button>

            <button
              onClick={handleSummarize}
              className={`w-full py-3 px-4 rounded-md font-bold transition duration-300 ${currentTheme.secondaryBg} ${currentTheme.secondaryHover} ${currentTheme.secondaryText} ${currentTheme.secondaryShadow}`}
            >
              VIEW SUMMARY
            </button>
            
            <button
              onClick={() => setIsNewSessionModalOpen(true)}
              className={`w-full py-3 px-4 rounded-md font-bold transition duration-300 ${currentTheme.redText} hover:${currentTheme.redHover} border ${currentTheme.mainBorder}`}
            >
              NEW SESSION
            </button>
          </div>
        </div>
      </div>
    );
  };

  // Modal component for session summary
  const SummaryModal = () => {
    const currentTheme = themeConfig[theme];

    // Download functions for Summary
    const downloadTxt = () => {
      const blob = new Blob([summary], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ctf_summary.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    const downloadJson = () => {
      const jsonSummary = {
        title: "Session Summary",
        date: new Date().toISOString(),
        summary: summary
      };
      const blob = new Blob([JSON.stringify(jsonSummary, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ctf_summary.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    const downloadPdf = async () => {
      const summaryElement = summaryRef.current;
      if (!summaryElement) {
        console.error("Summary element not found for PDF generation.");
        return;
      }

      // Load html2canvas and jsPDF from CDN for self-contained functionality
      const loadScript = (src) => {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = src;
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      };

      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');

      const { jsPDF } = window.jspdf;

      const pdf = new jsPDF('p', 'pt', 'a4');
      const margin = 20;
      const contentWidth = pdf.internal.pageSize.getWidth() - 2 * margin;

      try {
        const canvas = await html2canvas(summaryElement, { scale: 2 });
        const imgData = canvas.toDataURL('image/jpeg', 1.0);

        const imgHeight = canvas.height * contentWidth / canvas.width;
        let heightLeft = imgHeight;

        let position = 0;

        pdf.addImage(imgData, 'JPEG', margin, position, contentWidth, imgHeight);
        heightLeft -= pdf.internal.pageSize.getHeight();

        while (heightLeft > 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'JPEG', margin, position, contentWidth, imgHeight);
          heightLeft -= pdf.internal.pageSize.getHeight();
        }

        pdf.save('ctf_summary.pdf');

      } catch (error) {
        console.error('Error generating PDF:', error);
      }
    };

    return (
      <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div className={`${currentTheme.mainBg} rounded-lg p-8 w-11/12 md:w-2/3 lg:w-1/2 border ${currentTheme.mainBorder} ${currentTheme.mainNeonGlow}`}>
          <div className={`flex justify-between items-center border-b-2 ${currentTheme.mainBorder} pb-4 mb-4`}>
            <h3 className={`text-2xl font-bold ${currentTheme.mainText} ${currentTheme.mainNeonGlow}`}>SESSION SUMMARY</h3>
            <button onClick={() => setIsSummaryOpen(false)} className={`${currentTheme.mainText} hover:${currentTheme.mainText}`}>
              <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div ref={summaryRef} id="summary-content" className={`whitespace-pre-wrap ${currentTheme.mainText}`} style={{ maxHeight: '60vh', overflowY: 'auto' }}>
            {summary}
          </div>
          <div className="flex justify-end space-x-4 mt-6">
            <button
              onClick={downloadTxt}
              className={`py-2 px-4 rounded-md font-bold transition duration-300 ${currentTheme.secondaryBg} ${currentTheme.secondaryHover} ${currentTheme.secondaryText} ${currentTheme.secondaryShadow}`}
            >
              DOWNLOAD TXT
            </button>
            <button
              onClick={downloadJson}
              className={`py-2 px-4 rounded-md font-bold transition duration-300 ${currentTheme.secondaryBg} ${currentTheme.secondaryHover} ${currentTheme.secondaryText} ${currentTheme.secondaryShadow}`}
            >
              DOWNLOAD JSON
            </button>
            <button
              onClick={downloadPdf}
              className={`py-2 px-4 rounded-md font-bold transition duration-300 ${currentTheme.accentBg} ${currentTheme.accentHover} ${currentTheme.accentText} ${currentTheme.accentShadow}`}
            >
              DOWNLOAD PDF
            </button>
          </div>
        </div>
      </div>
    );
  };

  // Modal for new session confirmation
  const NewSessionConfirmationModal = () => {
    const currentTheme = themeConfig[theme];
    return (
      <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div className={`${currentTheme.mainBg} rounded-lg p-8 w-11/12 md:w-1/3 border ${currentTheme.mainBorder} ${currentTheme.mainNeonGlow}`}>
          <h3 className={`text-xl font-bold mb-4 ${currentTheme.mainText}`}>WARNING: POTENTIAL DATA LOSS</h3>
          <p className={`mb-6 ${currentTheme.mainText}`}>
            Are you sure you want to start a new session? This will clear all existing chat messages. This action cannot be undone.
          </p>
          <div className="flex justify-between space-x-4">
            <button
              onClick={() => setIsNewSessionModalOpen(false)}
              className={`flex-1 py-3 px-4 rounded-md font-bold transition duration-300 ${currentTheme.secondaryBg} ${currentTheme.secondaryHover} ${currentTheme.secondaryText} ${currentTheme.secondaryShadow}`}
            >
              CANCEL
            </button>
            <button
              onClick={handleConfirmNewSession}
              className={`flex-1 py-3 px-4 rounded-md font-bold transition duration-300 ${currentTheme.redText} hover:${currentTheme.redHover} border ${currentTheme.mainBorder}`}
            >
              CONFIRM
            </button>
          </div>
        </div>
      </div>
    );
  };

  // Report Modal
  const ReportModal = () => {
    const currentTheme = themeConfig[theme];

    // Download functions
    const downloadTxt = () => {
      const blob = new Blob([reportContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ctf_report.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    const downloadJson = () => {
      const jsonReport = {
        title: "Cybersecurity Report",
        date: new Date().toISOString(),
        content: reportContent
      };
      const blob = new Blob([JSON.stringify(jsonReport, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ctf_report.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    // PDF download function
    const downloadPdf = async () => {
      const reportElement = reportRef.current;
      if (!reportElement) {
        console.error("Report element not found for PDF generation.");
        return;
      }

      // Load html2canvas and jsPDF from CDN for self-contained functionality
      const loadScript = (src) => {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = src;
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      };

      // Assuming a safe environment, load scripts from CDN
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');

      const { jsPDF } = window.jspdf;

      const pdf = new jsPDF('p', 'pt', 'a4');
      const margin = 20;
      const contentWidth = pdf.internal.pageSize.getWidth() - 2 * margin;
      const contentHeight = reportElement.clientHeight;
      const scale = contentWidth / reportElement.offsetWidth;
      const scaledHeight = reportElement.offsetHeight * scale;

      try {
        const canvas = await html2canvas(reportElement, { scale: 2 });
        const imgData = canvas.toDataURL('image/jpeg', 1.0);

        const imgHeight = canvas.height * contentWidth / canvas.width;
        let heightLeft = imgHeight;

        let position = 0;

        pdf.addImage(imgData, 'JPEG', margin, position, contentWidth, imgHeight);
        heightLeft -= pdf.internal.pageSize.getHeight();

        while (heightLeft > 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'JPEG', margin, position, contentWidth, imgHeight);
          heightLeft -= pdf.internal.pageSize.getHeight();
        }

        pdf.save('ctf_report.pdf');

      } catch (error) {
        console.error('Error generating PDF:', error);
      }
    };


    return (
      <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div className={`${currentTheme.mainBg} rounded-lg p-8 w-11/12 md:w-3/4 lg:w-2/3 border ${currentTheme.mainBorder} ${currentTheme.mainNeonGlow}`}>
          <div className={`flex justify-between items-center border-b-2 ${currentTheme.mainBorder} pb-4 mb-4`}>
            <h3 className={`text-2xl font-bold ${currentTheme.mainText} ${currentTheme.mainNeonGlow}`}>CYBERSECURITY REPORT</h3>
            <button onClick={() => setIsReportModalOpen(false)} className={`${currentTheme.mainText} hover:${currentTheme.mainText}`}>
              <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          {isReportLoading ? (
            <div className="flex justify-center items-center h-64">
              <div className={`w-8 h-8 rounded-full border-4 border-t-4 border-gray-200 animate-spin`}
                   style={{ borderTopColor: theme === 'cyberpunk' ? '#0ff' : 'currentColor' }}></div>
            </div>
          ) : (
            <>
              <div ref={reportRef} id="report-content" className={`whitespace-pre-wrap ${currentTheme.mainText}`} style={{ maxHeight: '60vh', overflowY: 'auto' }}>
                {reportContent}
              </div>
              <div className="flex justify-end space-x-4 mt-6">
                <button
                  onClick={downloadTxt}
                  className={`py-2 px-4 rounded-md font-bold transition duration-300 ${currentTheme.secondaryBg} ${currentTheme.secondaryHover} ${currentTheme.secondaryText} ${currentTheme.secondaryShadow}`}
                >
                  DOWNLOAD TXT
                </button>
                <button
                  onClick={downloadJson}
                  className={`py-2 px-4 rounded-md font-bold transition duration-300 ${currentTheme.secondaryBg} ${currentTheme.secondaryHover} ${currentTheme.secondaryText} ${currentTheme.secondaryShadow}`}
                >
                  DOWNLOAD JSON
                </button>
                <button
                  onClick={downloadPdf}
                  className={`py-2 px-4 rounded-md font-bold transition duration-300 ${currentTheme.accentBg} ${currentTheme.accentHover} ${currentTheme.accentText} ${currentTheme.accentShadow}`}
                >
                  DOWNLOAD PDF
                </button>
              </div>
            </>
          )}
        </div>
      </div>
    );
  };

  // Modal component for AI Image Generation
  const ImageModal = () => {
    const currentTheme = themeConfig[theme];

    const handleGenerateImage = async () => {
      if (!imagePrompt.trim()) return;
      setIsImageLoading(true);
      setGeneratedImageUrl('');

      // API call to imagen-3.0-generate-002
      let retryCount = 0;
      const maxRetries = 5;
      const baseDelay = 1000;

      const callApi = async () => {
        try {
          const payload = { instances: { prompt: imagePrompt }, parameters: { "sampleCount": 1} };
          const apiKey = "";
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const result = await response.json();
          if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
            const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
            setGeneratedImageUrl(imageUrl);
          } else {
            console.error('Error generating image: unexpected response format.');
          }
        } catch (error) {
          console.error('Error fetching image from API:', error);
          if (retryCount < maxRetries) {
            retryCount++;
            const delay = baseDelay * Math.pow(2, retryCount);
            setTimeout(callApi, delay);
          }
        } finally {
          setIsImageLoading(false);
        }
      };

      callApi();
    };

    return (
      <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div className={`${currentTheme.mainBg} rounded-lg p-8 w-11/12 md:w-2/3 lg:w-1/2 border ${currentTheme.mainBorder} ${currentTheme.mainNeonGlow}`}>
          <div className={`flex justify-between items-center border-b-2 ${currentTheme.mainBorder} pb-4 mb-4`}>
            <h3 className={`text-2xl font-bold ${currentTheme.mainText} ${currentTheme.mainNeonGlow}`}>IMAGE GENERATOR</h3>
            <button onClick={() => { setIsImageModalOpen(false); setGeneratedImageUrl(''); setImagePrompt(''); }} className={`${currentTheme.mainText} hover:${currentTheme.mainText}`}>
              <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div className="space-y-4">
            <input
              type="text"
              value={imagePrompt}
              onChange={(e) => setImagePrompt(e.target.value)}
              className={`w-full bg-gray-800 ${currentTheme.userText} border ${currentTheme.userBorder} rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-${currentTheme.userText.substring(5, currentTheme.userText.indexOf('-'))}-500`}
              placeholder="Describe the image you want to generate..."
              disabled={isImageLoading}
            />
            <button
              onClick={handleGenerateImage}
              className={`w-full py-3 px-4 rounded-md font-bold transition duration-300 ${
                isImageLoading ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : `${currentTheme.accentBg} ${currentTheme.accentHover} ${currentTheme.accentText} ${currentTheme.accentShadow}`
              }`}
              disabled={isImageLoading}
            >
              {isImageLoading ? 'GENERATING...' : 'GENERATE IMAGE'}
            </button>
            {isImageLoading && (
              <div className="flex justify-center my-4">
                <div className="w-8 h-8 rounded-full border-4 border-t-4 border-gray-200 animate-spin"
                     style={{ borderTopColor: theme === 'cyberpunk' ? '#0ff' : 'currentColor' }}></div>
              </div>
            )}
            {generatedImageUrl && (
              <div className="mt-4 border-2 border-dashed border-gray-600 rounded-lg overflow-hidden">
                <img src={generatedImageUrl} alt="Generated by AI" className="w-full h-auto" />
              </div>
            )}
          </div>
        </div>
      </div>
    );
  };


  const currentTheme = themeConfig[theme];
  return (
    <div className={`${currentTheme.mainBg} ${currentTheme.mainText} font-mono h-screen p-8 antialiased flex flex-col lg:flex-row lg:space-x-8`}>
      <style>
        {`
          @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap');
          body {
            font-family: 'Space Mono', monospace;
          }
          .neon-glow-cyan {
            text-shadow: 0 0 5px #0ff, 0 0 10px #0ff, 0 0 20px #0ff, 0 0 40px #f0f, 0 0 80px #f0f;
          }
          .neon-glow-red {
            text-shadow: 0 0 5px #f00, 0 0 10px #f00, 0 0 20px #f00;
          }
          .neon-shadow-cyan {
            text-shadow: 0 0 5px #0ff;
          }
          .neon-shadow-purple {
            text-shadow: 0 0 5px #f0f;
          }
          .neon-shadow-red {
            text-shadow: 0 0 5px #f00;
          }
          .glitch-text {
            animation: glitch 1.5s infinite;
          }
          @keyframes glitch {
            0% { text-shadow: 0 0 5px #0ff; transform: translate(0, 0); }
            20% { text-shadow: 2px 2px 0px #f0f, -2px -2px 0px #0ff; transform: translate(2px, -2px); }
            40% { text-shadow: -2px -2px 0px #f0f, 2px 2px 0px #0ff; transform: translate(-2px, 2px); }
            60% { text-shadow: 2px -2px 0px #f0f, -2px 2px 0px #0ff; transform: translate(2px, 2px); }
            80% { text-shadow: -2px 2px 0px #f0f, 2px -2px 0px #0ff; transform: translate(-2px, -2px); }
            100% { text-shadow: 0 0 5px #0ff; transform: translate(0, 0); }
          }
          @keyframes pulse-border {
            0%, 100% { box-shadow: 0 0 5px #0ff, 0 0 10px #0ff, 0 0 15px #0ff; }
            50% { box-shadow: 0 0 10px #0ff, 0 0 20px #0ff, 0 0 30px #0ff; }
          }
          .pulse-border {
            animation: pulse-border 2s infinite;
          }
          .fade-in {
            animation: fadeIn 0.5s ease-in-out;
          }
          @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
          }
          .animate-pulse-slow {
            animation: pulse-slow 1.5s infinite;
          }
          @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
          }
          .peer:checked + label span {
            transform: translateX(100%);
          }
          .peer:checked + label {
            background-color: ${currentTheme.accentBg.substring(4)};
          }
        `}
      </style>
      {/* Left pane with Methodology and Toolbox */}
      <div className="flex flex-col w-full lg:w-1/4 space-y-8 mb-8 lg:mb-0 h-full">
        {/* Methodology Checklist Window */}
        <div className={`${currentTheme.mainBg} rounded-lg px-6 pt-6 pb-2 border ${currentTheme.mainBorder} h-3/5 overflow-y-auto`}>
          <h2 className={`text-xl font-bold mb-4 ${currentTheme.mainText} ${currentTheme.mainNeonGlow}`}>
            METHODOLOGY
          </h2>
          <ul className="space-y-4">
            {['Reconnaissance', 'Vulnerability Scanning', 'Exploitation', 'Post-Exploitation'].map(
              (phase, index) => (
                <li
                  key={index}
                  className={`p-2 cursor-pointer transition duration-300 rounded-md border-2 ${
                    currentPhase === phase
                      ? `${currentTheme.accentBg} ${currentTheme.buttonColor} ${currentTheme.mainBorder} ${currentTheme.accentShadow}`
                      : `border-${currentTheme.mainBorder} ${currentTheme.mainText} hover:${currentTheme.aiBg}`
                  }`}
                  onClick={() => setCurrentPhase(phase)}
                >
                  {phase}
                </li>
              )
            )}
          </ul>
        </div>
        {/* Toolbox Window */}
        <div className={`${currentTheme.mainBg} rounded-lg p-6 border ${currentTheme.userBorder} h-2/5 overflow-y-auto`}>
          <h2 className={`text-xl font-bold mb-4 ${currentTheme.userText} ${currentTheme.userNeonShadow}`}>
            TOOLBOX
          </h2>
          <ul className="space-y-2">
            {tools.map((tool, index) => (
              <li key={index}>
                <button
                  className={`w-full text-left p-2 transition duration-300 rounded-md border-2 ${
                    activeTool === tool
                      ? `${currentTheme.secondaryBg} ${currentTheme.secondaryText} ${currentTheme.userBorder} ${currentTheme.secondaryShadow}`
                      : `border-${currentTheme.userBorder} ${currentTheme.userText} hover:${currentTheme.aiBg}`
                  }`}
                  onClick={() => setActiveTool(tool)}
                >
                  {`> ${tool}`}
                </button>
              </li>
            ))}
          </ul>
        </div>
      </div>

      {/* Main Workspace */}
      <div className={`flex flex-col w-full lg:w-3/4 ${currentTheme.mainBg} rounded-lg p-6 border ${currentTheme.mainBorder} h-full`}>
        {/* Header with Title and Settings Icon */}
        <div className={`relative flex justify-between items-center mb-4 pb-4 border-b ${currentTheme.mainBorder}`}>
          {/* Left-aligned title */}
          <h2 className={`text-xl font-bold ${currentTheme.mainText} ${currentTheme.mainNeonGlow}`}>
            Gonzo Labs
          </h2>
          {/* Center-aligned title */}
          <h2 className={`text-xl font-bold absolute left-1/2 -translate-x-1/2 ${currentTheme.mainText} ${currentTheme.mainNeonGlow}`}>
            CTF Navigator
          </h2>
          {/* Right-aligned buttons */}
          <div className="flex space-x-2">
            {/* TTS Toggle Button */}
            <button onClick={() => setIsTtsEnabled(!isTtsEnabled)} className={`${currentTheme.mainText} hover:${currentTheme.accentBg} hover:${currentTheme.accentText} transition duration-300 rounded-md p-1`}>
              {isTtsEnabled ? (
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6">
                  <path strokeLinecap="round" strokeLinejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                </svg>
              ) : (
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6">
                  <path strokeLinecap="round" strokeLinejoin="round" d="M17.25 9.75L19.5 12m0 0l2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-6l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                </svg>
              )}
            </button>
            {/* Image Generation Button */}
            <button onClick={() => setIsImageModalOpen(true)} className={`${currentTheme.mainText} hover:${currentTheme.accentBg} hover:${currentTheme.accentText} transition duration-300 rounded-md p-1`}>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6">
                <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008v-.008zm.008 0h.008v.008h-.008v-.008zm-3.75 0h.008v.008h-.008v-.008z" />
              </svg>
            </button>
            {/* Settings Button */}
            <button onClick={() => setIsSettingsOpen(true)} className={`${currentTheme.mainText} hover:${currentTheme.accentBg} hover:${currentTheme.accentText} transition duration-300 rounded-md p-1`}>
              <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="3" />
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
              </svg>
            </button>
          </div>
        </div>
        {/* Chat message display area */}
        <div className="flex-1 overflow-y-auto pr-2">
          <div className="flex flex-col space-y-4">
            {messages.length === 0 ? (
              <div className={`text-center text-gray-500 mt-10 ${currentTheme.glitchText}`}>
                [SYSTEM_INITIATED]
                <br />
                _WELCOME, USER_
                <br />
                _TARGET_IDENTIFIED: PENTEST_
                <br />
                <span className={`${currentTheme.userText}`}>
                  _STATUS: STANDBY_
                </span>
                <br />
                <span className={`${currentTheme.aiText}`}>
                  _AWAITING_INPUT...
                </span>
              </div>
            ) : (
              messages.map(renderMessage)
            )}
            {isLoading && (
              <div className={`self-start text-left max-w-3/4 p-4 rounded-lg my-2 ${currentTheme.aiBg} ${currentTheme.aiText} ${currentTheme.aiNeonShadow}`}>
                <p className="font-bold text-sm mb-1">CTF Navigator</p>
                <div className="flex items-center space-x-2">
                  <div className={`w-2 h-2 rounded-full ${currentTheme.aiText} animate-pulse-slow`}></div>
                  <div className={`w-2 h-2 rounded-full ${currentTheme.aiText} animate-pulse-slow delay-150`}></div>
                  <div className={`w-2 h-2 rounded-full ${currentTheme.aiText} animate-pulse-slow delay-300`}></div>
                </div>
              </div>
            )}
          </div>
        </div>
        {/* User input form */}
        <form onSubmit={handleSendMessage} className={`mt-4 pt-4 border-t ${currentTheme.userBorder}`}>
          <div className="relative">
            {isTerminalMode && (
              <span className={`absolute left-3 top-1/2 -translate-y-1/2 ${currentTheme.userText} text-lg`}>$</span>
            )}
            <input
              type="text"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              className={`w-full bg-gray-800 ${currentTheme.userText} border ${currentTheme.userBorder} rounded-md p-3 pr-12 focus:outline-none focus:ring-2 focus:ring-purple-500 ${isTerminalMode ? 'pl-8' : ''}`}
              placeholder={isTerminalMode ? '' : '> Enter command...'}
              disabled={isLoading}
            />
            <button
              type="submit"
              className={`absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-md ${
                isLoading
                  ? 'bg-gray-600 cursor-not-allowed'
                  : `${currentTheme.secondaryBg} ${currentTheme.secondaryHover} ${currentTheme.secondaryText} ${currentTheme.secondaryShadow}`
              } transition duration-300`}
              disabled={isLoading}
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clipRule="evenodd" />
              </svg>
            </button>
          </div>
        </form>
      </div>
      {isSettingsOpen && <SettingsModal />}
      {isSummaryOpen && <SummaryModal />}
      {isImageModalOpen && <ImageModal />}
      {isNewSessionModalOpen && <NewSessionConfirmationModal />}
      {isReportModalOpen && <ReportModal />}
    </div>
  );
};

export default App;
